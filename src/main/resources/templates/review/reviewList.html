<!DOCTYPE html>
<html th:replace="~{template/layoutExtend/layoutFile :: layout(~{::title},~{::link},~{::content})}"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <title>âš“ë¦¬ë·°</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}"/>

</head>
<body>

<content>

    <div class="py-3 text-center">
        <h4>âš“ë¦¬ë·°</h4>
    </div>

    <div class="container">
        <div class="content">
            <div class="inner row">
                <p>
                    <th:block th:if="${loginMember}">
                        <a class="nav-contact" href="/review/new">ğŸ´ë¦¬ë·° ì“°ê¸°</a>
                    </th:block>
                </p>

            </div>

            <section>
                <div class="inner">
<!--                    ê²€ìƒ‰-->
                    <div class="search_box">
                        <form id="searchForm" onsubmit="return false;" autocomplete="off">
                            <div class="sch_group fl">
                                <select id="searchType" name="searchType" title="ê²€ìƒ‰ ìœ í˜• ì„ íƒ">
                                    <option value="">ì „ì²´ ê²€ìƒ‰</option>
                                    <option value="title">ì œëª©</option>
                                    <option value="content">ë‚´ìš©</option>
                                    <option value="memberNickName">ì‘ì„±ì</option>
                                    <option value="shop">ì‹ë‹¹</option>
                                </select>
                                <input type="text" id="keyword" name="keyword" placeholder="í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”."
                                       title="í‚¤ì›Œë“œ ì…ë ¥"/>
                                <button type="button" class="bt_search" onclick="movePage(1);"><i
                                        class="fas fa-search"></i><span class="skip_info">ê²€ìƒ‰</span></button>
                            </div>
                        </form>
                    </div>
                </div>
                <!--/* ë¦¬ìŠ¤íŠ¸ */-->
                <div class="table inner">
                    <table class="tb tb_col table">
                        <colgroup>
                            <!--                            <col style="width:60px;"/>-->
                            <col style="width:auto%;"/>
                            <col style="width:10%;"/>
                            <col style="width:20%;"/>
                            <col style="width:15%;"/>
                            <col style="width:70px;"/>
                        </colgroup>
                        <thead>
                        <tr class="table-primary">
                            <!--                <th scope="col"><input type="checkbox"/></th>-->
                            <!--                            <th scope="col">#</th>-->
                            <th scope="col">ì œëª©</th>
                            <th scope="col">ì‘ì„±ì</th>
                            <th scope="col">ì‹ë‹¹</th>
                            <th scope="col">ë“±ë¡ì¼</th>
                            <th scope="col">ì¡°íšŒ</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:if="${not #lists.isEmpty( response )}" th:each="row, status : ${response.list}">
                            <td class="tl"><a th:href="@{|/review/${row.boardId}|}" th:text="${row.title}"></a></td>
                            <td th:text="${row.nickName}"></td>
                            <td th:text="${row.shopName}"></td>
                            <td th:text="${#temporals.format( row.createdAt, 'yyyy-MM-dd' )}"></td>
                            <td th:text="${row.viewCnt}"></td>
                        </tr>

                        <tr th:unless="${not #lists.isEmpty( response )}">
                            <td colspan="5">
                                <div class="no_data_msg">ê²€ìƒ‰ëœ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="paging">

                </div>

            </section>
        </div> <!--/* .content */-->
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/

            window.onload = () => {

                setQueryStringParams();
                findAllPost();
            }

            // ì¿¼ë¦¬ ìŠ¤íŠ¸ë§ íŒŒë¼ë¯¸í„° ì…‹íŒ…
            function setQueryStringParams() {

                 if ( !location.search ) {
                    return false;
                    }

                 const form = document.getElementById('searchForm');

                 new URLSearchParams(location.search).forEach((value, key) => {
                 if (form[key]) {
                    form[key].value = value;
                     }
                  })
             }

            // ê²Œì‹œê¸€ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ
            function findAllPost() {

                // 1. PagingResponseì˜ ë©¤ë²„ì¸ List<T> íƒ€ì…ì˜ listë¥¼ ì˜ë¯¸
                const list = [[ ${response.list} ]];

                // 2. ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆëŠ” ê²½ìš°, í–‰ì— "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ë‹¤"ëŠ” ë©”ì‹œì§€ë¥¼ ì¶œë ¥í•˜ê³ , í˜ì´ì§€ ë²ˆí˜¸(í˜ì´ì§€ë„¤ì´ì…˜) HTMLì„ ì œê±°(ì´ˆê¸°í™”)í•œ í›„ ë¡œì§ì„ ì¢…ë£Œ
                if ( !list.length ) {
                    document.getElementById('list').innerHTML = '<td colspan="6"><div className="no_data_msg">ê²€ìƒ‰ëœ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div></td>';
                    drawPage();
                }

                // 3. PagingResponseì˜ ë©¤ë²„ì¸ paginationì„ ì˜ë¯¸
                const pagination = [[ ${response.pagination} ]];
                console.log(pagination);


                // 4. @ModelAttributeë¥¼ ì´ìš©í•´ì„œ ë·°(HTML)ë¡œ ì „ë‹¬í•œ SearchDto íƒ€ì…ì˜ ê°ì²´ì¸ paramsë¥¼ ì˜ë¯¸
                const searchDto = [[ ${searchDto} ]];
                console.log("======");
                console.log(searchDto);
                console.log("======");

                // 5. í˜ì´ì§€ ë²ˆí˜¸ ë Œë”ë§
                drawPage(pagination, searchDto);
            }


            // ë¦¬ìŠ¤íŠ¸ HTML draw


            // í˜ì´ì§€ HTML draw
            function drawPage(pagination, searchDto) {

                // 1. í•„ìˆ˜ íŒŒë¼ë¯¸í„°ê°€ ì—†ëŠ” ê²½ìš°, í˜ì´ì§€ ë²ˆí˜¸(í˜ì´ì§€ë„¤ì´ì…˜) HTMLì„ ì œê±°(ì´ˆê¸°í™”)í•œ í›„ ë¡œì§ ì¢…ë£Œ
                if ( !pagination || !searchDto ) {
                    document.querySelector('.paging').innerHTML = '';
                    throw new Error('Missing required parameters...');
                }

                // 2. ë Œë”ë§ í•  HTMLì„ ì €ì¥í•  ë³€ìˆ˜
                let html = '';

                // 3. ì´ì „ í˜ì´ì§€ê°€ ìˆëŠ” ê²½ìš°, ì¦‰ ì‹œì‘ í˜ì´ì§€(startPage)ê°€ 1ì´ ì•„ë‹Œ ê²½ìš° ì²« í˜ì´ì§€ ë²„íŠ¼ê³¼ ì´ì „ í˜ì´ì§€ ë²„íŠ¼ì„ HTMLì— ì¶”ê°€
                if (pagination.existPrevPage) {
                    html += `
                        <a href="javascript:void(0);" onclick="movePage(1)" class="page_bt first">ì²« í˜ì´ì§€</a>
                        <a href="javascript:void(0);" onclick="movePage(${pagination.startPage - 1})" class="page_bt prev">ì´ì „ í˜ì´ì§€</a>
                    `;
                }

                /*
                 * 4. ì‹œì‘ í˜ì´ì§€(startPage)ì™€ ë í˜ì´ì§€(endPage) ì‚¬ì´ì˜ í˜ì´ì§€ ë²ˆí˜¸(i)ë¥¼ ë„˜ë²„ë§ í•˜ëŠ” ë¡œì§
                 *    í˜ì´ì§€ ë²ˆí˜¸(i)ì™€ í˜„ì¬ í˜ì´ì§€ ë²ˆí˜¸(params.page)ê°€ ë™ì¼í•œ ê²½ìš°, í˜ì´ì§€ ë²ˆí˜¸(i)ë¥¼ í™œì„±í™”(on) ì²˜ë¦¬
                 */
                html += '<p>';
                for (let i = pagination.startPage; i <= pagination.endPage; i++) {
                    html += (i !== searchDto.page)
                        ? `<a href="javascript:void(0);" onclick="movePage(${i});">${i}</a>`
                        : `<span class="on">${i}</span>`
                }
                html += '</p>';

                // 5. í˜„ì¬ ìœ„ì¹˜í•œ í˜ì´ì§€ ë’¤ì— ë°ì´í„°ê°€ ë” ìˆëŠ” ê²½ìš°, ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼ê³¼ ë í˜ì´ì§€ ë²„íŠ¼ì„ HTMLì— ì¶”ê°€
                if (pagination.existNextPage) {
                    html += `
                        <a href="javascript:void(0);" onclick="movePage(${pagination.endPage + 1});" class="page_bt next">ë‹¤ìŒ í˜ì´ì§€</a>
                        <a href="javascript:void(0);" onclick="movePage(${pagination.totalPageCount});" class="page_bt last">ë§ˆì§€ë§‰ í˜ì´ì§€</a>
                    `;
                }

                // 6. classê°€ "paging"ì¸ ìš”ì†Œë¥¼ ì°¾ì•„ HTMLì„ ë Œë”ë§
                document.querySelector('.paging').innerHTML = html;
            }

            // í˜ì´ì§€ ì´ë™
            function movePage(page) {

                const form = document.getElementById('searchForm');

                // 1. drawPage( )ì˜ ê° ë²„íŠ¼ì— ì„ ì–¸ëœ onclick ì´ë²¤íŠ¸ë¥¼ í†µí•´ ì „ë‹¬ë°›ëŠ” page(í˜ì´ì§€ ë²ˆí˜¸)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê°ì²´ ìƒì„±
                const queryParams = {
                    page: (page) ? page : 1,
                    recordSize: 10,
                    pageSize: 10,
                    searchType: form.searchType.value,
                    keyword: form.keyword.value
                }

                /*
                 * 2. location.pathname : ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€ì˜ URI("/review/list")ë¥¼ ì˜ë¯¸
                 *    new URLSearchParams(queryParams).toString() : queryParamsì˜ ëª¨ë“  í”„ë¡œí¼í‹°(key-value)ë¥¼ ì¿¼ë¦¬ ìŠ¤íŠ¸ë§ìœ¼ë¡œ ë³€í™˜
                 *    URI + ì¿¼ë¦¬ ìŠ¤íŠ¸ë§ì— í•´ë‹¹í•˜ëŠ” ì£¼ì†Œë¡œ ì´ë™
                 *
                 */
                location.href = location.pathname + '?' + new URLSearchParams(queryParams).toString();
            }
        /*]]>*/

    </script>
</content>

</body>
</html>